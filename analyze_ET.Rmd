---
title: "ET_data"
author: "Francesco Pupillo"
date: '2023-03-14'
output: 
  #github_document:
  md_document:
    variant: markdown_github
    toc: true
    toc_depth: 6
---

Scripts that analyze eye tracking data and count the missing cases

```{r setup, include=FALSE}
# get the packages
rm(list=ls())
library(ggplot2)
library(Rmisc)
library(dplyr)
source("helper_functions/get_fixations.R")
knitr::opts_chunk$set(include = T, warning = FALSE)

# what is the time window of the fixations?
time_window<-"1500_2500"
```

First, get the data
```{r warning=FALSE, include=FALSE}
cd<-getwd()
setwd("pilot_data")
# get the participants
participants<-list.files()

# create an empty file to store all the participants' data
all_file<-vector()

# loop through participants and get the data
for (sub in participants){

  sub_n<-substr(sub, 5, 7)

  # encoding data
  data_encoding<-read.csv(paste0( sub, "/beh/", sub_n, "_encoding.csv"))

    # remove nas
  data_encoding<-data_encoding[!is.na(data_encoding$radians),]
  # add the trial n by block
  # count how many first scenario
  lists<-unique(data_encoding$list)
  n_list1<-nrow(data_encoding[data_encoding$list==lists[1],])
  n_list2<-nrow(data_encoding[data_encoding$list==lists[2],])
  
  data_encoding$trial_n_block<-c(1:n_list1, 1:n_list2)
  
  file_path<-paste0(sub, "/et/", sub, 
                             "_eye-right_last-fixation_et.csv")
  
  if (file.exists(file_path)){
  # get the data
    data_et<-read.csv(file_path)
    
    # get prediction and prediction error
    data_encoding<-get_fixations(data_encoding, data_et)
  # append to the data
  all_file<-rbind(all_file, data_encoding)
  # get the 
  
  }
}

# save the file
setwd(cd)
write.csv(all_file, paste0("output_data/ET_data_",time_window,".csv"))

```

Aggregated into wide
```{r}
# get data 2000_2500
data_20_25<-read.csv("output_data/ET_data_2000_2500.csv")
data_20_25<-data_20_25[, names(all_file)]

data_20_25$time_window<-"2000_2500"
all_file$time_window<-"1500_2500"

# exclude singletons
data_20_25<-data_20_25[data_20_25$type!="singletons",]
all_file<-all_file[all_file$type!="singletons",]

# bind the two
all_tw<-rbind(all_file, data_20_25)

# countNA
all_tw$count_NA<-ifelse(is.na(all_tw$x), 1,0)

# summarize
all_tw_agg<- all_tw %>%
  group_by(participant, time_window) %>%
  summarize(count_NA = sum(count_NA),
  fixation_prediction = mean(fixation_prediction, na.rm=T))
            
#
library("reshape2")

all_tw_agg_wide <- melt(all_tw_agg, id.vars=c("participant", "time_window"), 
                             measure.vars = c("count_NA", "fixation_prediction") )


# select only 15
agg_wide_15<-all_tw_agg_wide[all_tw_agg_wide$time_window=="1500_2500",]
agg_wide_20<-all_tw_agg_wide[all_tw_agg_wide$time_window=="2000_2500",]


agg_wide_15_agg<-agg_wide_15 %>%
  pivot_wider(names_from = variable, values_from = value)

names(agg_wide_15_agg)[3:4]<-c("count_NA_1500_2500", "fixation_prediction_1500_2500")

agg_wide_20_agg<-agg_wide_20 %>%
  pivot_wider(names_from = variable, values_from = value)

names(agg_wide_20_agg)[3:4]<-c("count_NA_2000_2500", "fixation_prediction_2000_2500")

# merge the two
agg_wide_all_agg<-merge(agg_wide_20_agg[, c(1, 3,4)], agg_wide_15_agg[, c(1,3,4)], by = 'participant')

# print
write.csv(agg_wide_all_agg, "output_data/data_aggr_wide.csv")

```

```{R}
ggplot(all_tw %>%
         group_by(participant,time_window)%>%
         dplyr::summarise(count_NA=mean(count_NA, na.rm=T)), 
       aes(x = time_window, y = count_NA, colour = time_window ))+
    geom_bar(aes(time_window, count_NA, fill = time_window),
           position="dodge",stat="summary")+
  # Add some points, which correspond to the participants
  geom_point(alpha = 0.10, colour = "black" )+
  # add a line that connect those points by participant
  # add a summary line (mean)
  xlab("")
  
  theme_classic()
#  # delete the x axis text and ticks, as we have the legend

  
  ggplot(all_tw %>%
         group_by(participant,time_window)%>%
         dplyr::summarise(fixation_prediction=mean(fixation_prediction, na.rm=T)), 
       aes(x = time_window, y = fixation_prediction, colour = time_window ))+
    geom_bar(aes(time_window, fixation_prediction, fill = time_window),
           position="dodge",stat="summary")+
  # Add some points, which correspond to the participants
  geom_point(alpha = 0.10, colour = "black" )+
  stat_summary(fun.data = "mean_cl_boot", size = 0.8, geom="errorbar", width=0.2 )+ # this line adds error bars

  # add a line that connect those points by participant
  # add a summary line (mean)
  xlab("")
  
  theme_classic()
```
